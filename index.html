<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>IPTV Player - Audio Fixed</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{background:#000;color:#fff;font-family:system-ui;overflow:hidden}
        #player{width:100vw;height:100vh;background:#000}
        #overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:999;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:20px;display:none}
        #controls{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.98);backdrop-filter:blur(20px);padding:20px;box-shadow:0-10px 40px rgba(255,64,129,0.5)}
        button{background:#ff4081;color:#fff;border:0;padding:12px 24px;margin:6px;border-radius:25px;font-size:16px;font-weight:700;min-width:100px;box-shadow:0 4px 20px rgba(255,64,129,0.4);transition:all .2s}
        button:active{transform:scale(.95)}
        select{background:rgba(255,255,255,.1);color:#fff;padding:12px;border-radius:12px;width:100%;margin:8px 0;font-size:16px;border:1px solid rgba(255,255,255,.3)}
        #channels{max-height:220px;overflow:auto;background:rgba(255,255,255,.05);border-radius:12px;margin:10px 0;padding:10px}
        .channel{padding:12px;cursor:pointer;border-radius:8px;font-size:15px;transition:all .2s;border-bottom:1px solid rgba(255,255,255,.1)}
        .channel:hover,.channel.active{background:#ff4081}
        #status{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.9);padding:12px 20px;border-radius:25px;font-size:14px}
        #audio-status{position:fixed;top:60px;left:50%;transform:translateX(-50%);padding:10px 15px;border-radius:20px;font-size:12px}
        #volume{width:100%;margin:10px 0;height:6px;background:#333;border-radius:3px}
    </style>
</head>
<body>
    <!-- üéµ AUDIO UNLOCK OVERLAY -->
    <div id="overlay">
        <div style="font-size:48px;margin-bottom:20px;">üîä</div>
        <div style="font-size:24px;margin-bottom:10px;">Click to Enable Audio</div>
        <button onclick="unlockAndPlay()" style="font-size:20px;padding:15px 40px;">START PLAYING</button>
        <div style="margin-top:20px;font-size:14px;color:#ccc;">Touch anywhere to unlock sound</div>
    </div>

    <div id="status">Loading...</div>
    <div id="audio-status">Audio: üîá</div>
    
    <video id="player" 
           preload="auto" 
           playsinline 
           webkit-playsinline 
           x5-playsinline 
           style="width:100vw;height:100vh;object-fit:contain;background:#000">
    </video>

    <div id="controls">
        <select id="playlist" onchange="loadPlaylist()">
            <option value="https://iptv-eum.pages.dev/XxXAll.m3u">üì∫ All Channels</option>
        </select>
        <div id="channels"></div>
        <div>
            <input type="range" id="volume" min="0" max="1" step="0.1" value="0.8" oninput="video.volume=this.value">
            <button id="mute" onclick="toggleMute()">üîä</button>
            <button onclick="prev()">‚èÆÔ∏è</button>
            <button onclick="next()" style="background:#00e676">‚ñ∂Ô∏è</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('player');
        const overlay = document.getElementById('overlay');
        const hls = new Hls({enableWorker:false,lowLatencyMode:true});
        let channels = [], currentIndex = 0;
        
        // üéµ CRITICAL AUDIO FIXES
        video.volume = 0.8;
        video.muted = false;
        let userInteracted = false;

        // 1. USER GESTURE REQUIRED - Click ·Äî·Äæ·Ä≠·Äï·Ä∫·Äï·Äº·ÄÆ·Ä∏·Äô·Äæ audio
        function unlockAndPlay() {
            userInteracted = true;
            overlay.style.display = 'none';
            video.muted = false;
            video.volume = 1.0;
            document.getElementById('audio-status').innerHTML = 'Audio: üîä ON';
            loadPlaylist();
        }

        // 2. Touch/Click ·Äõ·ÄÑ·Ä∫ auto unlock
        document.addEventListener('click', function(e) {
            if(!userInteracted) {
                unlockAndPlay();
            }
        }, {once: true});

        document.addEventListener('touchstart', function(e) {
            if(!userInteracted) {
                unlockAndPlay();
            }
        }, {once: true});

        // 3. M3U Load with AUDIO PRIORITY
        async function loadPlaylist() {
            const url = document.getElementById('playlist').value;
            document.getElementById('status').textContent = 'Loading channels...';
            
            try {
                // CORS Proxy for M3U
                const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const res = await fetch(proxy);
                const data = await res.json();
                const m3u = data.contents;
                
                parseM3U(m3u);
                document.getElementById('status').textContent = `${channels.length} channels ‚úì`;
            } catch(e) {
                document.getElementById('status').textContent = '‚ùå Load failed';
            }
        }

        function parseM3U(text) {
            channels = [];
            const lines = text.split('\n');
            let ch = null;
            
            for(let line of lines) {
                if(line.startsWith('#EXTINF')) {
                    ch = {name: line.split(',').pop()?.trim() || 'Channel'};
                } else if(line.startsWith('http') && ch) {
                    ch.url = line.trim();
                    channels.push(ch);
                    ch = null;
                }
            }
            showChannels();
            if(channels[0]) play(0);
        }

        function showChannels() {
            document.getElementById('channels').innerHTML = 
                channels.slice(0,25).map((ch,i)=>`
                    <div class="channel ${i===currentIndex?'active':''}" onclick="play(${i})">
                        üì∫ ${ch.name}
                    </div>
                `).join('');
        }

        // üéµ AUDIO GUARANTEED PLAY
        async function play(index) {
            if(index<0||index>=channels.length) return;
            currentIndex = index;
            showChannels();
            
            const ch = channels[index];
            document.getElementById('status').textContent = ch.name;
            
            if(userInteracted) {
                video.muted = false;  // FORCE UNMUTE
                video.volume = 1.0;
            }
            
            try {
                if(ch.url.includes('.m3u8')) {
                    hls.loadSource(ch.url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, ()=> {
                        video.play();
                    });
                } else {
                    video.src = ch.url;
                    await video.load();
                    video.play();
                }
            } catch(e) {
                document.getElementById('status').textContent = '‚ùå Stream error';
            }
        }

        function toggleMute() {
            video.muted = !video.muted;
            document.getElementById('mute').textContent = video.muted ? 'üîá' : 'üîä';
            document.getElementById('audio-status').textContent = `Audio: ${video.muted ? 'üîá' : 'üîä'}`;
        }

        function prev() { play(currentIndex-1); }
        function next() { play(currentIndex+1 % channels.length); }

        // Remote/TV Controls
        document.addEventListener('keydown', e=>{
            if(!userInteracted) return;
            switch(e.code) {
                case 'ArrowLeft': prev(); break;
                case 'ArrowRight': next(); break;
                case 'ArrowUp': video.volume = Math.min(1, video.volume + 0.1); break;
                case 'ArrowDown': video.volume = Math.max(0, video.volume - 0.1); break;
                case 'Space': video.paused ? video.play() : video.pause(); break;
            }
        });

        // Show overlay first
        overlay.style.display = 'flex';
        document.getElementById('status').textContent = 'Click to start ÔøΩÔøΩ';
    </script>
</body>
</html>
